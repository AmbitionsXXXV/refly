generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["tracing", "omitApi"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                Int      @id @default(autoincrement())
  userId            Int      @map("user_id")
  type              String   @map("type")
  provider          String   @map("provider")
  providerAccountId String   @map("provider_account_id")
  refreshToken      String?  @map("refresh_token")
  accessToken       String?  @map("access_token")
  expiresAt         Int?     @map("expires_at")
  scope             String?  @map("scope")
  /// 创建时间
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

//邮箱
model VerificationToken {
  id         Int      @id @default(autoincrement())
  identifier String   @map("identifier")
  token      String   @unique @map("token")
  expires    DateTime @map("expires") @db.Timestamptz()

  @@unique([identifier, token])
  @@map("verification_token")
}

model User {
  /// 主键
  id            Int       @id @default(autoincrement())
  /// UID
  uid           String    @default("") @map("uid")
  /// 头像
  avatar        String?   @map("avatar")
  /// 用户名
  name          String?   @map("name")
  /// 邮箱
  email         String?   @unique @map("email")
  /// 邮箱是否已验证
  emailVerified DateTime? @map("email_verified") @db.Timestamptz()
  /// 密码
  password      String?   @map("password")
  /// 界面语言设置
  uiLocale      String?   @default("") @map("ui_locale")
  /// 输出语言设置
  outputLocale  String?   @default("") @map("output_locale")
  /// 创建时间
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz()

  @@map("users")
}

/// 内容主题
model Topic {
  /// 主键
  id          Int      @id @default(autoincrement())
  /// 主题 id
  topicId     String?  @default("") @map("topic_id")
  /// 主题 key
  key         String   @unique @map("key")
  /// 多语言名称 JSON 字符串 (key: 语言, val: 名称)
  name        String   @map("name")
  /// 多语言描述 JSON 字符串 (key: 语言, val: 名称)
  description String   @map("description")
  /// 创建时间
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  userPreferences UserPreference[]

  @@map("topics")
}

/// 用户喜好
model UserPreference {
  /// 主键
  id        Int      @id @default(autoincrement())
  /// 用户id
  userId    Int      @map("user_id")
  /// 主题key
  topicKey  String   @map("topic_key")
  /// 兴趣值
  score     Float    @default(0) @map("score")
  /// 创建时间
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz()
  /// 关联的 topic
  topic     Topic?   @relation(fields: [topicKey], references: [key])

  @@unique([userId, topicKey])
  @@index([topicKey])
  @@map("user_preferences")
}

// Conversation
model Conversation {
  /// Primary key
  id              Int      @id @default(autoincrement())
  /// Conversation ID
  convId          String   @unique @default("") @map("conv_id")
  /// UID
  uid             String   @default("") @map("uid")
  /// Conversation title
  title           String   @map("title")
  /// Last message content
  lastMessage     String   @default("") @map("last_message")
  /// Message count
  messageCount    Int      @default(0) @map("message_count")
  /// Conversation origin page
  origin          String   @default("") @map("origin")
  // Conversation origin page url
  originPageUrl   String   @default("") @map("origin_page_url")
  /// Conversation source page title
  originPageTitle String   @default("") @map("origin_page_title")
  /// Create timestamp
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  /// Update timestamp
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([uid, updatedAt])
  @@map("conversations")
}

/// Conversation messages
model ChatMessage {
  /// Primary key
  id                    Int         @id @default(autoincrement())
  /// Message id
  msgId                 String      @default("") @map("msg_id")
  /// Conversation ID
  convId                String      @default("") @map("conv_id")
  /// Message type
  type                  MessageType @map("type")
  /// UID
  uid                   String      @default("") @map("uid")
  /// Message content
  content               String      @map("content")
  /// Skill metadata
  skillMeta             String      @default("{}") @map("skill_meta")
  /// Logs output
  logs                  String      @default("[]") @map("logs")
  /// Structured data output (JSON)
  structuredData        String      @default("{}") @map("structured_data")
  /// Locale setting
  locale                String?     @default("") @map("locale")
  /// Create timestamp
  createdAt             DateTime    @default(now()) @map("created_at") @db.Timestamptz()
  /// Update timestamp
  updatedAt             DateTime    @updatedAt @map("updated_at") @db.Timestamptz()
  /// 会话选中 Weblink 配置，未来可能会变，先使用 string 保存
  selectedWeblinkConfig String?     @map("selected_weblink_config")

  @@index([convId, updatedAt])
  @@map("chat_messages")
}

/// 用户访问网页记录
model UserWeblink {
  /// id为主键
  id                    Int      @id @default(autoincrement())
  /// 关联的链接 id
  weblinkId             Int      @map("weblink_id")
  /// 网页链接
  url                   String   @map("url")
  /// 会话来源 origin
  origin                String   @default("") @map("origin")
  /// 用户id
  userId                Int      @map("user_id")
  // 会话来源的 url
  originPageUrl         String   @default("") @map("origin_page_url")
  /// 会话来源页面标题
  originPageTitle       String   @default("") @map("origin_page_title")
  /// 会话来源页面的描述
  originPageDescription String   @default("") @map("origin_page_description")
  /// 最近访问时间
  lastVisitTime         DateTime @default(now()) @map("last_visit_time") @db.Timestamptz()
  /// 访问次数
  visitTimes            Int      @default(0) @map("visit_times")
  /// 总阅读时长（单位秒）
  totalReadTime         Int      @default(0) @map("total_read_time")
  /// 创建时间
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([userId, url])
  @@map("user_weblinks")
}

/// 网页数据
model Weblink {
  /// id为主键
  id                  Int         @id @default(autoincrement())
  /// 网页id
  linkId              String?     @default("") @map("link_id")
  /// 网页链接
  url                 String      @unique @map("url")
  /// 页面内容 (deprecated)
  pageContent         String      @map("page_content")
  /// 对象存储 key (html)
  storageKey          String      @default("") @map("storage_key")
  /// 内容解析来源
  parseSource         ParseSource @default(serverCrawl) @map("parse_source")
  /// 页面元数据, JSON 存储
  pageMeta            String      @map("page_meta")
  /// 内容元数据, JSON 存储
  contentMeta         String      @map("content_meta")
  /// 解析策略版本，格式统一为 YYYYMMDD
  parserVersion       String?     @default("00000000") @map("parser_version")
  /// 解析状态
  parseStatus         IndexStatus @default(init) @map("parse_status")
  /// 解析后文档存储 key (markdown)
  parsedDocStorageKey String?     @default("") @map("parsed_doc_storage_key")
  /// 切块状态
  chunkStatus         IndexStatus @default(init) @map("chunk_status")
  /// 切块后数据存储 key (avro)
  chunkStorageKey     String?     @default("") @map("chunk_storage_key")
  /// 网页内容总结
  summary             String?     @default("") @map("summary")
  /// 相关问题
  relatedQuestions    String[]    @default([]) @map("related_questions")
  /// 上次解析时间
  lastParseTime       DateTime?   @default(now()) @map("last_parse_time") @db.Timestamptz()
  /// 创建时间
  createdAt           DateTime    @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt           DateTime    @updatedAt @map("updated_at") @db.Timestamptz()

  contents AigcContent[]

  @@map("weblinks")
}

model WeblinkUserMark {
  /// id为主键
  id               Int      @id @default(autoincrement())
  /// 网页 id
  weblinkId        Int      @map("weblink_id")
  /// 用户 id
  userId           Int      @map("user_id")
  /// 网页 host
  linkHost         String   @map("link_host")
  /// 选中元素
  selector         String   @map("selector")
  /// 插件版本
  extensionVersion String   @map("extension_version")
  /// 标记类型
  markType         String   @map("mark_type")
  /// 创建时间
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([weblinkId, userId])
  @@index([weblinkId, selector])
  @@map("weblink_user_marks")
}

/// 知识库资源
model Resource {
  /// 主键
  id              BigInt       @id @default(autoincrement())
  /// 资源项 id
  resourceId      String       @unique @map("resource_id")
  /// 资源类型
  resourceType    ResourceType @map("resource_type")
  /// UID
  uid             String       @default("") @map("uid")
  /// Collection ID
  collectionId    String       @default("") @map("collection_id")
  /// 字数
  wordCount       Int          @default(0) @map("word_count")
  /// Content of resource
  content         String       @default("") @map("content")
  /// Yjs 状态数据存储 key
  stateStorageKey String       @default("") @map("state_storage_key")
  /// 是否公开
  isPublic        Boolean      @default(false) @map("is_public")
  /// 是否只读
  readOnly        Boolean      @default(false) @map("read_only")
  /// 索引状态
  indexStatus     IndexStatus  @default(init) @map("index_status")
  /// 标题
  title           String       @map("title")
  /// 资源元数据
  meta            String       @map("meta")
  /// 创建时间
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz()
  /// 软删除标记
  deletedAt       DateTime?    @map("deleted_at") @db.Timestamptz()

  @@index([collectionId])
  @@index([uid, updatedAt])
  @@map("resources")
}

/// 知识集
model Collection {
  /// 主键
  id           BigInt    @id @default(autoincrement())
  /// 知识集 id
  collectionId String    @unique @map("collection_id")
  /// 标题
  title        String    @map("title")
  /// 描述
  description  String?   @default("") @map("description")
  /// UID
  uid          String    @default("") @map("uid")
  /// 是否公开
  isPublic     Boolean   @default(false) @map("is_public")
  /// 创建时间
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  /// 软删除标记
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz()

  @@index([uid, updatedAt])
  @@map("collections")
}

/// User-defined skills.
model SkillInstance {
  /// Primary key
  pk          BigInt    @id @default(autoincrement())
  /// Skill id
  skillId     String    @unique @map("skill_id")
  /// Skill name (correspond to names of skill templates)
  skillName   String    @map("skill_name")
  /// Skill display name
  displayName String    @default("") @map("display_name")
  /// UID of skill owner
  uid         String    @map("uid")
  /// Workflow configuration (JSON)
  config      String    @default("{}") @map("config")
  /// Create timestamp
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  /// Update timestamp
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  /// Deletion timestamp
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz()

  @@index([uid, updatedAt])
  @@map("skill_instances")
}

model SkillTrigger {
  /// Primary key
  pk        BigInt    @id @default(autoincrement())
  /// Trigger id
  triggerId String    @unique @map("trigger_id")
  /// Skill id
  skillId   String    @map("skill_id")
  /// Owner UID
  uid       String    @map("uid")
  /// Trigger event
  event     String    @map("event")
  /// Crontab for cron trigger
  crontab   String?   @map("crontab")
  /// Whether this skill is enabled
  enabled   Boolean   @map("enabled")
  /// Create timestamp
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  /// Update timestamp
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  /// Deletion timestamp
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  @@index([skillId, deletedAt])
  @@map("skill_triggers")
}

/// Running logs of skills.
model SkillLog {
  /// Primary key
  pk             BigInt       @id @default(autoincrement())
  /// Skill log id
  logId          String       @unique @map("log_id")
  /// Skill id
  skillId        String       @map("skill_id")
  /// Skill name
  skillName      String       @map("skill_name")
  /// Mode for this skill run
  mode           SkillRunMode @map("mode")
  /// Input (JSON of `SkillInput`)
  input          String       @map("input")
  /// Context (JSON of `SkillContext`)
  context        String       @map("context")
  /// Skill config to override
  overrideConfig String       @map("override_config")
  /// Skill operation status
  status         SkillStatus  @map("status")
  /// Skill trigger event
  event          String       @map("event")
  /// Skill trigger id
  triggerId      String       @map("trigger_id")
  /// UID of skill owner
  uid            String       @map("uid")
  /// Create timestamp
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz()
  /// Update timestamp
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([uid, updatedAt])
  @@map("skill_log")
}

/// 生成内容
model AigcContent {
  /// 主键
  id         Int               @id @default(autoincrement())
  /// 内容id
  cid        String?           @default("") @map("cid")
  /// 标题
  title      String            @map("title")
  /// 摘要
  abstract   String            @default("") @map("abstract")
  /// 内容
  content    String            @map("content")
  /// 元数据, JSON 存储
  meta       String            @map("meta")
  /// 来源类型
  sourceType ContentSourceType @map("source_type")
  /// 引用文档来源，JSON 字符串
  sources    String?           @default("") @map("sources")
  /// 创建时间
  createdAt  DateTime          @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt  DateTime          @updatedAt @map("updated_at") @db.Timestamptz()
  /// 关联的链接 id
  weblinkId  Int?              @map("weblink_id")
  /// 输入内容 id
  inputIds   Int[]             @map("input_ids")
  /// 输出内容 id
  outputIds  Int[]             @map("output_ids")

  /// 关联的链接
  weblink     Weblink?      @relation(fields: [weblinkId], references: [id])
  /// 关联的摘要
  userDigests UserDigest[]
  /// 输入内容
  inputs      AigcContent[] @relation("content_graph")
  /// 输出内容
  outputs     AigcContent[] @relation("content_graph")

  @@index([weblinkId])
  @@map("aigc_contents")
}

/// 用户回顾
model UserDigest {
  /// 主键
  id        Int         @id @default(autoincrement())
  /// 摘要 id
  digestId  String?     @default("") @map("digest_id")
  /// 用户 id
  userId    Int         @map("user_id")
  /// 日期 (YYYY-MM-DD)
  date      String      @map("date")
  /// 主题
  topicKey  String      @map("topic_key")
  /// 回顾内容 id
  contentId Int         @unique @map("content_id")
  /// 创建时间
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz()
  /// 更新时间
  updatedAt DateTime    @updatedAt @map("updated_at") @db.Timestamptz()
  /// 关联的回顾内容
  content   AigcContent @relation(fields: [contentId], references: [id])

  // @@unique([userId, date, topicKey])
  @@map("user_digests")
}

enum ResourceType {
  weblink
  note
}

enum ContentSourceType {
  weblink
  digest
  aigc
}

enum ContentMetaType {
  topic
  entity
  form
}

enum ParseSource {
  serverCrawl
  clientUpload
}

enum IndexStatus {
  init
  processing
  finish
  failed
}

enum SkillStatus {
  scheduling
  running
  finish
  failed
}

enum SkillRunMode {
  async
  stream
}

enum MessageType {
  ai
  human
  system
}
